<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureHer Live Location</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA0kHChkc5NHL0Eoh4JzBKR6KyepOUWRGU"></script>
    <script src="firebase-config.js"></script>
    <script src="tracking.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .info-window {
            padding: 10px;
        }
        .info-window h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .info-window p {
            margin: 0;
            color: #666;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading" style="display: none;">
        <h3>Loading Location...</h3>
        <p>Please wait while we connect to the live location feed.</p>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBP4V9QM6aT3QjNTM5squPpPGd6EMgAWJE",
            authDomain: "her-eab33.firebaseapp.com",
            projectId: "her-eab33",
            storageBucket: "her-eab33.firebasestorage.app",
            messagingSenderId: "1051763109707",
            appId: "1:1051763109707:web:7c5b4402c54150b9ca02ce"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Get sharing code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sharingCode = urlParams.get('code');

        if (!sharingCode) {
            document.body.innerHTML = '<div class="loading"><h3>Error</h3><p>No sharing code provided in URL.</p></div>';
        } else {
            // Initialize map
            let map;
            let marker;
            let infoWindow;

            function initMap() {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 0, lng: 0 },
                    zoom: 15
                });

                infoWindow = new google.maps.InfoWindow();
                marker = new google.maps.Marker({
                    map: map,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    }
                });

                // Start tracking location
                trackLocation(sharingCode);
            }

            async function trackLocation(sharingCode) {
                document.getElementById('loading').style.display = 'block';

                try {
                    // Get the sharing document
                    const sharingDoc = await db.collection('location_sharing')
                        .where('sharing_code', '==', sharingCode)
                        .get();

                    if (sharingDoc.empty) {
                        throw new Error('Invalid sharing code');
                    }

                    const userId = sharingDoc.docs[0].data().user_id;

                    // Listen for location updates
                    db.collection('users').doc(userId)
                        .onSnapshot((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                if (data.isSharingLocation && data.location) {
                                    const location = data.location;
                                    const position = {
                                        lat: location.latitude,
                                        lng: location.longitude
                                    };

                                    // Update marker position
                                    marker.setPosition(position);
                                    map.setCenter(position);

                                    // Update info window
                                    const content = `
                                        <div class="info-window">
                                            <h3>Live Location</h3>
                                            <p>Last updated: ${new Date().toLocaleTimeString()}</p>
                                            <p>Latitude: ${location.latitude.toFixed(6)}</p>
                                            <p>Longitude: ${location.longitude.toFixed(6)}</p>
                                        </div>
                                    `;
                                    infoWindow.setContent(content);
                                    infoWindow.open(map, marker);

                                    document.getElementById('loading').style.display = 'none';
                                }
                            }
                        });
                } catch (error) {
                    document.body.innerHTML = `
                        <div class="loading">
                            <h3>Error</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }

            // Initialize the map when the page loads
            window.onload = initMap;
        }
    </script>
</body>
</html>
